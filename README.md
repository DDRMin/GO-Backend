# GO-Backend Service

A lightweight Go REST API template using chi, pgx, sqlc, and golang-migrate. Ships with PostgreSQL migrations, typed query interfaces, and a starter products endpoint ready to expand.

## Features
- HTTP server with chi middleware: request ID, real IP, structured logging, recovery, and request timeouts
- PostgreSQL connectivity via pgx with default port binding on :8080
- Database migrations managed by golang-migrate (CLI or the bundled Go entrypoint)
- Type-safe query layer generated by sqlc from versioned SQL and schema files
- Minimal products handler illustrating routing, services, and JSON responses

## Architecture
- [cmd/main.go](cmd/main.go): API entrypoint; loads env config, connects to Postgres, boots the server
- [cmd/api.go](cmd/api.go): router, middleware stack, HTTP server lifecycle
- [cmd/migrate/main.go](cmd/migrate/main.go): migration CLI wrapper around golang-migrate
- [internal/env](internal/env): environment helpers
- [internal/json](internal/json): JSON response helper
- [internal/products](internal/products): products service and HTTP handler
- [internal/adapters/migrations](internal/adapters/migrations): SQL migrations (up/down)
- [internal/adapters/sqlc](internal/adapters/sqlc): sqlc config outputs and [queries.sql](internal/adapters/sqlc/queries.sql)
- [sqlc.yml](sqlc.yml): sqlc generation configuration

## Prerequisites
- Go 1.22+ (module declares 1.25.5; use the latest stable 1.22/1.23 toolchain)
- PostgreSQL 14+ running locally or accessible via `DB_URL`
- golang-migrate CLI (`choco install golang-migrate` on Windows, `brew install golang-migrate` on macOS)
- sqlc (`scoop install sqlc` on Windows, `go install github.com/sqlc-dev/sqlc/cmd/sqlc@latest`)

## Quickstart
1) Clone and download dependencies
```bash
go mod download
```

2) Export database URL (defaults to local Postgres if unset)
```bash
set DB_URL=postgres://user:password@localhost:5432/mydb?sslmode=disable
```

3) Run migrations (up)
```bash
go run cmd/migrate/main.go -cmd=up
```

4) Start the API server
```bash
go run cmd/main.go
```

5) Call the endpoints
- Health/root: `GET http://localhost:8080/`
- Products: `GET http://localhost:8080/products`

## API Surface (current)
| Method | Path | Description |
| --- | --- | --- |
| GET | / | Basic liveness response |
| GET | /products | Returns products payload (empty placeholder) |

## Configuration
| Variable | Description | Default |
| --- | --- | --- |
| DB_URL | PostgreSQL connection string | postgres://user:password@localhost:5432/mydb?sslmode=disable |

## Database and Migrations
- Migration files live in [internal/adapters/migrations](internal/adapters/migrations).
- Use the bundled CLI wrapper for consistent settings:
```bash
# Apply all pending up migrations
go run cmd/migrate/main.go -cmd=up

# Roll back the last migration (or N steps)
go run cmd/migrate/main.go -cmd=down -steps=1

# Show current migration version
go run cmd/migrate/main.go -cmd=version
```

To add a migration:
```bash
migrate create -ext sql -dir internal/adapters/migrations -seq add_feature_name
```
Edit the generated up/down SQL files, then rerun the migration command.

## SQLC Codegen Workflow
1) Update [internal/adapters/sqlc/queries.sql](internal/adapters/sqlc/queries.sql) and the schema in [internal/adapters/migrations](internal/adapters/migrations).
2) Regenerate Go types and query interfaces:
```bash
sqlc generate
```

## Development Notes
- Server listens on :8080 by default; adjust `addr` in [cmd/api.go](cmd/api.go) if needed.
- Logging uses `log/slog` with text output to stdout.
- The products service is a stub; extend [internal/products/service.go](internal/products/service.go) and [internal/products/handlers.go](internal/products/handlers.go) with real data access via the sqlc-generated repo types.

## Troubleshooting
- Connection errors: verify `DB_URL`, ensure Postgres is reachable, and migrations are applied.
- Migration dirty state: the CLI logs the current version and dirty flag; fix via `migrate force <version>` if required.
- sqlc errors: ensure queries compile against the current schema and that `sqlc.yml` paths are correct.
